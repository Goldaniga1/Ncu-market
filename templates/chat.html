<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆ‡ {{ target_user['name'] }} èŠå¤©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .chat-box { height: 60vh; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .message { max-width: 70%; padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; font-size: 0.95em; position: relative; }
        .message.mine { align-self: flex-end; background-color: #0084ff; color: white; border-bottom-right-radius: 2px; }
        .message.theirs { align-self: flex-start; background-color: #f1f0f0; color: black; border-bottom-left-radius: 2px; }
        .message-time { font-size: 0.7em; margin-top: 3px; opacity: 0.7; text-align: right; }
        .input-area { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <a href="{{ url_for('inbox') }}" style="text-decoration:none;">â† è¿”å›åˆ—è¡¨</a>
            <h3 style="margin:0;">{{ target_user['name'] }}</h3>
            <div style="width: 60px;"></div>
        </div>

        <div class="chat-box" id="chatBox">
            {% for msg in history %}
                <div class="message {{ 'mine' if msg['sender_id'] == current_user.id else 'theirs' }}">
                    {{ msg['content'] }}
                </div>
            {% endfor %}
        </div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯..." style="flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc;">
            <button id="sendBtn" onclick="sendMessage()" class="btn-primary" 
                    style="width: auto; border-radius: 20px; padding: 0 20px; white-space: nowrap;">
                å‚³é€
            </button>
        </div>
    </div>

    <script>
        var socket = io();
        var targetId = Number("{{ target_id }}");
        var myId = Number("{{ current_user.id }}");
        var chatBox = document.getElementById('chatBox');

        // 1. é€£ç·šå¾ŒåŠ å…¥æˆ¿é–“
        socket.on('connect', function() {
            socket.emit('join_chat', {target_id: targetId});
            scrollToBottom();
        });

        // 2. æ¥æ”¶æ–°è¨Šæ¯ (å³æ™‚ï¼)
        socket.on('new_message', function(data) {
            var msgDiv = document.createElement('div');
            if (data.sender_id == myId) {
                msgDiv.className = 'message mine';
                // ğŸ‘‡ å¦‚æœæ˜¯è‡ªå·±å‚³çš„è¨Šæ¯å›ä¾†äº†ï¼Œæ¢å¾©æŒ‰éˆ•ç‹€æ…‹ï¼Œä¸¦æ¸…ç©ºè¼¸å…¥æ¡†
                var btn = document.getElementById('sendBtn');
                btn.disabled = false;
                btn.innerText = "å‚³é€";
                document.getElementById('msgInput').value = ""; // ç¢ºå®šæˆåŠŸæ‰æ¸…ç©º
                document.getElementById('msgInput').focus();    // æŠŠæ¸¸æ¨™æ”¾å›å»
            } else {
                msgDiv.className = 'message theirs';
            }
            msgDiv.innerText = data.content;
            chatBox.appendChild(msgDiv);
            scrollToBottom();
        });

        // 3. å‚³é€è¨Šæ¯
        function sendMessage() {
            var input = document.getElementById('msgInput');
            var btn = document.getElementById('sendBtn'); // æŠ“å–æŒ‰éˆ•
            var msg = input.value;
            
            if (msg.trim() !== "") {
                // ğŸ‘‡ ç«‹å³é–ä½æŒ‰éˆ•ï¼Œæ”¹è®Šæ–‡å­—
                btn.disabled = true;
                btn.innerText = "å‚³é€ä¸­...";
                
                socket.emit('send_message', {target_id: targetId, message: msg});
                // æ³¨æ„ï¼šé€™è£¡ä¸è¦æ¸…ç©º inputï¼Œç­‰ server ç¢ºèªæ”¶åˆ° (new_message) å†æ¸…ç©º
            }
        }

        // æŒ‰ Enter ä¹Ÿèƒ½ç™¼é€
        document.getElementById('msgInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") sendMessage();
        });

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>